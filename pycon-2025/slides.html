<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no">
    <title>Writing Extension Modules to be Interruptible</title>
    <link rel="stylesheet" href="rjs/theme-mc-sol-dark.css">
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <div class="l-title-card">
            <h1>Writing Extension Modules<br>to be Interruptible</h1>
            <div class="author-card">
              <img src="picassohead-me.svg" width="240" height="240">
              <div class="author-handles">
                <p><strong>Zack Weinberg</strong></p>
                <p>〈<code class="email">zack@millionconcepts.com</code>〉</p>
                <p>〈<code class="email">zack@owlfolio.org</code>〉</p>
                <p><a href="https://www.owlfolio.org"><code>https://www.owlfolio.org/</code></a></p>
              </div>
            </div>
            <a class="venue" href="https://us.pycon.org/2025/"><img src="pycon-2025-us-logo.svg" alt="PyCon US 2025" height="70" width="218"></a>
          </div>
        </section>
        <section>
          <h2>A Common Bug</h2>
          <div class="sidebyside">
            <div class="sidebyside-1">
              <pre class="language-python-repl"
><span class="h-prompt">&gt;&gt;&gt; </span><span class="h-keyword h-namespace">import</span> <span class="h-name h-namespace">random</span>
<span class="h-prompt">&gt;&gt;&gt; </span><span class="h-keyword">def</span> <span class="h-defun">f</span><span class="h-delim">(</span><span class="h-variable">n</span><span class="h-operator">=</span><span class="h-number h-integer">100000000</span><span class="h-delim">):</span>
<span class="h-prompt">... </span>    <span class="h-keyword">return</span> <span class="h-delim">[</span><span class="h-name">random</span><span class="h-operator">.</span><span class="h-name">random</span><span class="h-delim">()</span>
<span class="h-prompt">... </span>        <span class="h-keyword">for</span> <span class="h-name">_</span> <span class="h-operator-word">in</span> <span class="h-name h-builtin">range</span><span class="h-delim">(</span><span class="h-name">n</span><span class="h-delim">)]</span>
<span class="h-prompt">...</span>
<span class="h-prompt">&gt;&gt;&gt; </span><span class="h-name">f</span><span class="h-delim">()</span>
<span class="h-output fragment" data-fragment-index="1">^C</span
><span class="fragment" data-fragment-index="2"><span class="h-traceback">Traceback (most recent call last):
  File <span class="h-name h-builtin">&quot;&lt;stdin&gt;&quot;</span>, line <span class="h-number">1</span>, in <span class="h-name">&lt;module&gt;</span>
  File <span class="h-name h-builtin">&quot;&lt;stdin&gt;&quot;</span>, line <span class="h-number">2</span>, in <span class="h-name">f</span>
<span class="h-name h-class">KeyboardInterrupt</span></span>
<span class="h-prompt">&gt;&gt;&gt;</span></span></pre>
              <p class="fragment" data-fragment-index="4"><span class="r-frame">&nbsp;&lt; 0.1 s&nbsp;</span></p>
            </div>
            <div class="sidebyside-2">
              <pre class="language-python-repl"
><span class="h-prompt">&gt;&gt;&gt; </span><span class="h-keyword h-namespace">import</span> <span class="h-name h-namespace">numpy</span> <span class="h-keyword">as</span> <span class="h-name h-namespace">np</span>
<span class="h-prompt">&gt;&gt;&gt; </span><span class="h-variable">rng</span> <span class="h-operator">=</span> <span class="h-name">np</span><span class="h-operator">.</span><span class="h-name">random</span><span class="h-operator">.</span><span class="h-name">default_rng</span><span class="h-delim">()</span>
<span class="h-prompt">&gt;&gt;&gt; </span><span class="h-keyword">def</span> <span class="h-defun">g</span><span class="h-delim">(</span><span class="h-variable">n</span><span class="h-operator">=</span><span class="h-number h-integer">1000000000</span><span class="h-delim">):</span>
<span class="h-prompt">... </span>    <span class="h-keyword">return</span> <span class="h-name">rng</span><span class="h-operator">.</span><span class="h-name">random</span><span class="h-delim">(</span><span class="h-name">n</span><span class="h-delim">)</span>
<span class="h-prompt">...</span>
<span class="h-prompt">&gt;&gt;&gt; </span><span class="h-name">g</span><span class="h-delim">()</span>
<span class="h-output fragment" data-fragment-index="1">^C</span
><span class="fragment" data-fragment-index="3"><span class="h-traceback">Traceback (most recent call last):
  File <span class="h-name h-builtin">&quot;&lt;stdin&gt;&quot;</span>, line <span class="h-number">1</span>, in <span class="h-name">&lt;module&gt;</span>
  File <span class="h-name h-builtin">&quot;&lt;stdin&gt;&quot;</span>, line <span class="h-number">2</span>, in <span class="h-name">g</span>
<span class="h-name h-class">KeyboardInterrupt</span></span>
<span class="h-prompt">&gt;&gt;&gt;</span></span></pre>
              <p class="fragment" data-fragment-index="4"><span class="r-frame">&nbsp;3.5 s&nbsp;</span></p>
            </div>
          </div>
        </section>
        <section>
          <h2>What went wrong</h2>
          <ul>
            <li>NumPy didn’t call <code>PyErr_CheckSignals</code></li>
            <li>Common bug in compiled-code extensions</li>
            <li class="fragment fade-up">This talk is about:
              <ol>
                <li>Why extensions need to do that</li>
                <li>Why, today, many extensions <i>don’t</i> do that</li>
                <li>How we can make it easier to do that</li>
              </ol></li>
          </ul>
        </section>
        <section>
          <h2>Audience background check</h2>
          <p>Raise your hand if…</p>
          <ul>
            <li class="fragment">you’ve written code in a compiled language
              <ul>
                <li class="fragment">C or assembly, specifically</li>
              </ul></li>
            <li class="fragment">you’ve written a compiled-code extension for CPython
              <ul>
                <li class="fragment">using the C-API directly, no helper libraries</li>
              </ul></li>
            <li class="fragment">you’ve written a multithreaded program</li>
            <li class="fragment">you’ve written a signal handler</li>
            <li class="fragment">you know the difference between thread-safe and async-signal-safe</li>
          </ul>
        </section>
        <section>
          <h2>What <kbd>Control-C</kbd> Does<sup>1</sup></h2>
          <div class="sidebyside">
            <div class="sidebyside-1">
              <ul>
                <li>Starts out like any keystroke</li>
                <li>Converted to a <i>signal</i>, <code>SIGINT</code></li>
                <li class="fragment fade-up" data-fragment-index="1">
                  <code>SIGINT</code> <span class="fragment highlight-green" data-fragment-index="2">delivered</span>
                  to Python interpreter</li>
                <li class="fragment fade-up" data-fragment-index="1">Python interpreter <span class=
                "fragment highlight-blue" data-fragment-index="2">reacts</span> by raising
                <code>KeyboardInterrupt</code></li>
              </ul>
            </div>
            <div class="sidebyside-2"></div>
          </div>
          <p class="footnote">
            <sup>1</sup> Except on Windows</p>
        </section>
        <section>
          <h2>Signal Delivery</h2>
          <div class="sidebyside">
            <div class="sidebyside-1">
              <pre class="language-python-repl"
><span class="h-prompt">&gt;&gt;&gt; </span><span class="h-keyword h-namespace">import</span> <span class="h-name h-namespace">random</span>
<span class="h-prompt">&gt;&gt;&gt; </span><span class="h-keyword">def</span> <span class="h-defun">f</span><span class="h-delim">(</span><span class="h-variable">n</span><span class="h-operator">=</span><span class="h-number h-integer">100000000</span><span class="h-delim">):</span>
<span class="h-prompt">... </span>    <span class="h-keyword">return</span> <span class="h-delim">[</span><span class="h-name">random</span><span class="h-operator">.</span><span class="h-name">random</span><span class="h-delim">()</span>
<span class="h-prompt">... </span>        <span class="h-keyword">for</span> <span class="h-name">_</span> <span class="h-operator-word">in</span> <span class="h-name h-builtin">range</span><span class="h-delim">(</span><span class="h-name">n</span><span class="h-delim">)]</span>
<span class="h-prompt">...</span>
<span class="h-prompt">&gt;&gt;&gt; </span><span class="h-name">f</span><span class="h-delim">()</span>
<span class="fragment" data-fragment-index="1"><span class="h-output">^C
Program received signal SIGINT
pymalloc_pool_extend ()
    at Objects/obmalloc.c:1361</span>
<span class="h-prompt">(gdb)</span></span><span class="fragment" data-fragment-index="2"> signal SIGINT
<span class="h-output">Continuing with signal SIGINT.
Breakpoint 2, signal_handler (sig_num=2)
    at ./Modules/signalmodule.c:347</span>
<span class="h-prompt">(gdb)</span></span></pre>
            </div>
            <div class="sidebyside-2">
              <pre class="language-python-repl"
><span class="h-prompt">&gt;&gt;&gt; </span><span class="h-keyword h-namespace">import</span> <span class="h-name h-namespace">numpy</span> <span class="h-keyword">as</span> <span class="h-name h-namespace">np</span>
<span class="h-prompt">&gt;&gt;&gt; </span><span class="h-variable">rng</span> <span class="h-operator">=</span> <span class="h-name">np</span><span class="h-operator">.</span><span class="h-name">random</span><span class="h-operator">.</span><span class="h-name">default_rng</span><span class="h-delim">()</span>
<span class="h-prompt">&gt;&gt;&gt; </span><span class="h-keyword">def</span> <span class="h-defun">g</span><span class="h-delim">(</span><span class="h-variable">n</span><span class="h-operator">=</span><span class="h-number h-integer">1000000000</span><span class="h-delim">):</span>
<span class="h-prompt">... </span>    <span class="h-keyword">return</span> <span class="h-name">rng</span><span class="h-operator">.</span><span class="h-name">random</span><span class="h-delim">(</span><span class="h-name">n</span><span class="h-delim">)</span>
<span class="h-prompt">...</span>
<span class="h-prompt">&gt;&gt;&gt; </span><span class="h-name">g</span><span class="h-delim">()</span>
<span class="fragment" data-fragment-index="1"><span class="h-output">^C
Program received signal SIGINT
random_standard_uniform_fill ()
    at 0x00007ffff00b23a7</span>
<span class="h-prompt">(gdb)</span></span><span class="fragment" data-fragment-index="2"> signal SIGINT
<span class="h-output">Continuing with signal SIGINT.
Breakpoint 2, signal_handler (sig_num=2)
    at ./Modules/signalmodule.c:347</span>
<span class="h-prompt">(gdb)</span></span>
</pre>
            </div>
          </div>
        </section>
        <section>
          <h2>Signal Delivery</h2>
          <div class="sidebyside">
            <div class="sidebyside-1">
              <pre class="language-text"
><span class="fragment semi-fade-out" data-fragment-index="1"><span class="h-output">Breakpoint 2, signal_handler (sig_num=2)</span>
<span class="h-output">    at ./Modules/signalmodule.c:347</span>
<span class="h-prompt">(gdb)</span> backtrace</span>
<span class="h-output"><span class="h-furniture">#0</span>  signal_handler <span class="h-furniture">(sig_num=2)</span></span>
<span class="h-output"><span class="h-furniture">#1</span>  &lt;signal handler called&gt;</span>
<span class="h-output"><span class="h-furniture">#2</span>  pymalloc_pool_extend <span class="h-furniture">(…)</span></span>
<span class="fragment semi-fade-out" data-fragment-index="1"><span class="h-output"><span class="h-furniture">#3</span>  pymalloc_alloc <span class="h-furniture">(…)</span></span>
<span class="h-output"><span class="h-furniture">#4</span>  _PyObject_Malloc <span class="h-furniture">(…)</span></span>
<span class="h-output"><span class="h-furniture">#5</span>  _PyLong_FromMedium <span class="h-furniture">(…)</span></span>
<span class="h-output"><span class="h-furniture">#6</span>  PyLong_FromLong <span class="h-furniture">(…)</span></span>
<span class="h-output"><span class="h-furniture">#7</span>  _PyEval_EvalFrameDefault <span class="h-furniture">(…)</span></span>
<span class="h-output"><span class="h-furniture">#8</span>  PyEval_EvalCode <span class="h-furniture">(…)</span></span>

<span class="h-output">(etc. etc.)</span></span>
</pre>
            </div>
            <div class="sidebyside-2">
              <pre class="language-text"
><span class="fragment semi-fade-out" data-fragment-index="1"><span class="h-output">Breakpoint 2, signal_handler (sig_num=2)</span>
<span class="h-output">    at ./Modules/signalmodule.c:347</span>
<span class="h-prompt">(gdb)</span> backtrace</span>
<span class="h-output"><span class="h-furniture">#0</span>  signal_handler <span class="h-furniture">(sig_num=2)</span></span>
<span class="h-output"><span class="h-furniture">#1</span>  &lt;signal handler called&gt;</span>
<span class="h-output"><span class="h-furniture">#2</span>  random_standard_uniform_fill <span class="h-furniture">(…)</span></span>
<span class="fragment semi-fade-out" data-fragment-index="1"><span class="h-output"><span class="h-furniture">#3</span>  __pyx_f_5numpy_6random_7_common_f… <span class="h-furniture">(…)</span></span>
<span class="h-output"><span class="h-furniture">#4</span>  __pyx_pw_5numpy_6random_10_genera… <span class="h-furniture">(…)</span></span>
<span class="h-output"><span class="h-furniture">#5</span>  method_vectorcall_FASTCALL_KEYWORDS <span class="h-furniture">(…)</span></span>
<span class="h-output"><span class="h-furniture">#6</span>  _PyObject_VectorcallTstate <span class="h-furniture">(…)</span></span>
<span class="h-output"><span class="h-furniture">#7</span>  PyObject_Vectorcall <span class="h-furniture">(…)</span></span>
<span class="h-output"><span class="h-furniture">#8</span>  _PyEval_EvalFrameDefault <span class="h-furniture">(…)</span></span>
<span class="h-output"><span class="h-furniture">#9</span>  PyEval_EvalCode <span class="h-furniture">(…)</span></span></span>
</pre>
            </div>
          </div>
        </section>
        <section>
          <h2>How did we get here???</h2>
          <div class="sidebyside">
            <div class="sidebyside-1">
              <pre class="language-text"
><span class="h-prompt">(gdb)</span> backtrace
<span class="h-output"><span class="h-furniture">#0</span>  signal_handler <span class="h-furniture">(sig_num=2)</span></span>
<span class="h-output"><span class="h-furniture">#1</span>  &lt;signal handler called&gt;<span class="h-furniture"></span></span>
<span class="h-output"><span class="h-furniture">#2</span>  pymalloc_pool_extend <span class="h-furniture">(…)</span></span>
<span class="h-output h-furniture">...</span>
</pre>
            </div>
            <div class="sidebyside-2">
              <pre class="language-text"
><span class="h-prompt">(gdb)</span><span class="fragment" data-fragment-index="1"> up
<span class="h-output"><span class="h-furniture">#1</span>  &lt;signal handler called&gt;<span class="h-furniture"></span></span>
<span class="h-prompt">(gdb)</span></span><span class="fragment" data-fragment-index="2"> disassemble
<span class="h-output">Assembly dump of __restore_rt:</span>
<span class="h-output"><span class="h-furniture">=&gt; &lt;+0&gt;:</span>    <span class="h-opcode">mov</span>  <span class="h-variable">rax</span><span class="h-delim">,</span> <span class="h-constant">SYS_rt_sigreturn</span></span>
<span class="h-output"><span class="h-furniture">   &lt;+7&gt;:</span>    <span class="h-opcode">syscall</span></span>
<span class="h-prompt">(gdb)</span></span><span class="fragment" data-fragment-index="3"> up
<span class="h-output"><span class="h-furniture">#2</span>  pymalloc_pool_extend <span class="h-furniture">(…)</span></span>
<span class="h-prompt">(gdb)</span></span><span class="fragment" data-fragment-index="4"> disassemble
<span class="h-output">Assembly dump of pymalloc_pool_extend:</span>
<span class="h-output h-furniture">...</span>
<span class="h-output"><span class="h-furniture">   &lt;+473&gt;:</span>  <span class="h-opcode">mov</span>  dword <span class="h-delim">[</span><span class="h-name h-variable">rdx</span>+<span class="h-number h-integer">40</span><span class="h-delim">]</span><span class="h-delim">,</span> <span class="h-name h-variable">ecx</span></span>
<span class="h-output"><span class="h-furniture">=&gt; &lt;+476&gt;:</span>  <span class="h-opcode">mov</span>  qword <span class="h-delim">[</span><span class="h-name h-variable">rdi</span><span class="h-delim">]</span><span class="h-delim">,</span> <span class="h-number h-integer">0</span></span>
<span class="h-output h-furniture">...</span></span></span>
</pre>
            </div>
          </div>
        </section>
        <section>
          <h2>The black magic of signal delivery</h2>
          <div class="sidebyside">
            <div class="sidebyside-1">
              <ul>
                <li>Kernel “preempted” execution of <code>pymalloc_pool_extend</code></li>
                <li>
                  <em>Forged</em> stack frames to make CPU <em>behave as if</em> <code>pymalloc_pool_extend</code>
                  called <code>__restore_rt</code> which called <code>signal_handler</code></li>
                <li>Resumed execution at beginning of <code>signal_handler</code></li>
              </ul>
            </div>
            <div class="sidebyside-2">
              <pre class="language-text"
><span class="h-prompt">(gdb)</span> up
<span class="h-output"><span class="h-furniture">#1</span>  &lt;signal handler called&gt;<span class="h-furniture"></span></span>
<span class="h-prompt">(gdb)</span> disassemble
<span class="h-output">Assembly dump of __restore_rt:</span>
<span class="h-output"><span class="h-furniture">=&gt; &lt;+0&gt;:</span>    <span class="h-opcode">mov</span>  <span class="h-variable">rax</span><span class="h-delim">,</span> <span class="h-constant">SYS_rt_sigreturn</span></span>
<span class="h-output"><span class="h-furniture">   &lt;+7&gt;:</span>    <span class="h-opcode">syscall</span></span>
<span class="h-prompt">(gdb)</span> up
<span class="h-output"><span class="h-furniture">#2</span>  pymalloc_pool_extend <span class="h-furniture">(…)</span></span>
<span class="h-prompt">(gdb)</span> disassemble
<span class="h-output">Assembly dump of pymalloc_pool_extend:</span>
<span class="h-output h-furniture">...</span>
<span class="h-output"><span class="h-furniture">   &lt;+473&gt;:</span>  <span class="h-opcode">mov</span>  dword <span class="h-delim">[</span><span class="h-name h-variable">rdx</span>+<span class="h-number h-integer">40</span><span class="h-delim">]</span><span class="h-delim">,</span> <span class="h-name h-variable">ecx</span></span>
<span class="h-output"><span class="h-furniture">=&gt; &lt;+476&gt;:</span>  <span class="h-opcode">mov</span>  qword <span class="h-delim">[</span><span class="h-name h-variable">rdi</span><span class="h-delim">]</span><span class="h-delim">,</span> <span class="h-number h-integer">0</span></span></span>
<span class="h-output h-furniture">...</span>
</pre>
            </div>
          </div>
        </section>
        <section>
          <h2>What <kbd>Control-C</kbd> Does<sup>1</sup></h2>
          <div class="sidebyside">
            <div class="sidebyside-1">
              <ul>
                <li>Starts out like any keystroke</li>
                <li>Converted to a <i>signal</i>, <code>SIGINT</code></li>
                <li>
                  <code>SIGINT</code> delivered to Python interpreter</li>
                <li>Python interpreter <span class="fragment highlight-blue" data-fragment-index="1">reacts</span> by
                raising <code>KeyboardInterrupt</code></li>
              </ul>
            </div>
            <div class="sidebyside-2">
              <div class="fragment pale-blue-box" data-fragment-index="1">
                <ul>
                  <li>C signal handler only sets a flag</li>
                  <li>Nothing more happens until control returns to the main interpreter loop</li>
                  <li>Main loop checks the flag in some (not all!) bytecode ops</li>
                  <li>If the flag is set, raises <code>KeyboardInterrupt</code></li>
                </ul>
              </div>
            </div>
          </div>
          <p class="footnote">
            <sup>1</sup> Except on Windows</p>
        </section>
        <section>
          <h2>What NumPy isn’t doing</h2>
          <div class="sidebyside">
            <div class="sidebyside-1">
              <pre class="language-python"
><span class="h-keyword">def</span> <span class="h-defun">f</span><span class="h-delim">(</span><span class="h-variable">rng</span><span class="h-delim">,</span> <span class="h-variable">out</span><span class="h-delim">):</span>
    <span class="h-keyword">for</span> <span class="h-variable">i</span> <span class="h-operator-word">in</span> <span class="h-name h-builtin">range</span><span class="h-delim">(</span><span class="h-name h-builtin">len</span><span class="h-delim">(</span><span class="h-name">out</span><span class="h-delim">)):</span>
        <span class="h-name">out</span><span class="h-delim">[</span><span class="h-name">i</span><span class="h-delim">]</span> <span class="h-operator">=</span> <span class="h-name">rng</span><span class="h-operator">.</span><span class="h-name">random</span><span class="h-delim">()</span>
</pre>
              <pre class="fragment fade-up language-pybytecode" data-fragment-index="1"
> <span class="h-delim">[</span><span class="h-label">42</span><span class="h-delim">]</span>  <span class="h-opcode">FOR_ITER</span>        <span class="h-delim">to [</span><span class="h-label">96</span><span class="h-delim">]</span>
       <span class="h-opcode">STORE_FAST</span>       <span class="h-delim">1 (</span>i<span class="h-delim">)</span>
       <span class="h-opcode">LOAD_FAST</span>        <span class="h-delim">2 (</span>rng<span class="h-delim">)</span>
       <span class="h-opcode">LOAD_ATTR</span>        <span class="h-delim">5 (</span>NULL|self + random<span class="h-delim">)</span>
       <span class="h-opcode">CALL</span>             0
       <span class="h-opcode">LOAD_FAST</span>        <span class="h-delim">0 (</span>out<span class="h-delim">)</span>
       <span class="h-opcode">LOAD_FAST</span>        <span class="h-delim">1 (</span>i<span class="h-delim">)</span>
       <span class="h-opcode">STORE_SUBSCR</span>
       <span class="h-opcode h-recur">JUMP_BACKWARD</span>   <span class="h-delim">to [</span><span class="h-label">42</span><span class="h-delim">]</span>
 <span class="h-delim">[</span><span class="h-label">96</span><span class="h-delim">]</span>  <span class="h-opcode">END_FOR</span>
</pre>
            </div>
            <div class="sidebyside-2">
              <pre class="language-c"
><span class="h-keyword h-type"><span class="fragment custom delete" data-fragment-index="3">void</span><span class="fragment custom insert" data-fragment-index="3">int</span></span>
<span class="h-defun">random_standard_uniform_fill</span><span class="h-delim">(</span>
    <span class="h-type">bitgen_t *</span><span class="h-variable">rng</span><span class="h-delim">,</span>
    <span class="h-type">npy_intp</span> <span class="h-variable">cnt</span><span class="h-delim">,</span> <span class="h-keyword h-type">double</span> <span class="h-type">*</span><span class="h-variable">out</span><span class="h-delim">)</span>
<span class="h-delim">{</span>
  <span class="h-type">npy_intp</span> <span class="h-variable">i</span><span class="h-delim">;</span>
  <span class="h-keyword">for</span> <span class="h-delim">(</span><span class="h-name">i</span> <span class="h-operator">=</span> <span class="h-number h-integer">0</span><span class="h-delim">;</span> <span class="h-name">i</span> <span class="h-operator">&lt;</span> <span class="h-name">cnt</span><span class="h-delim">;</span> <span class="h-name">i</span><span class="h-operator">++</span><span class="h-delim">)</span> <span class="h-delim">{</span>
    <span class="h-name">out</span><span class="h-delim">[</span><span class="h-name">i</span><span class="h-delim">]</span> <span class="h-operator">=</span> <span class="h-name">next_double</span><span class="h-delim">(</span><span class="h-name">rng</span><span class="h-delim">);</span>
    <span class="fragment custom insert" data-fragment-index="3"><span class="h-keyword">if</span> <span class="h-delim">(</span><span class="h-name">PyErr_CheckSignals</span><span class="h-delim">())</span></span>
    <span class="fragment custom insert" data-fragment-index="3">  <span class="h-keyword">return</span> <span class="h-number h-integer">-1</span><span class="h-delim">;</span></span>
  <span class="h-delim">}</span>
  <span class="fragment custom insert" data-fragment-index="3"><span class="h-keyword">return</span> <span class="h-number h-integer">0</span><span class="h-delim">;</span></span>
<span class="h-delim">}</span>
</pre>
              <pre class="fragment fade-up language-asm" data-fragment-index="2"
><span class="h-label">.L3</span><span class="h-delim">:</span>
    <span class="h-opcode">mov</span>    <span class="h-variable">rdi</span><span class="h-delim">,</span> <span class="h-variable">r12</span>
    <span class="h-opcode">call</span>   <span class="h-name h-function">next_double</span>
    <span class="h-opcode">movsd</span>  qword <span class="h-delim">[</span><span class="h-variable">r13</span>+<span class="h-variable">rbx</span>*<span class="h-number">8</span><span class="h-delim">],</span> <span class="h-variable">xmm0</span>
    <span class="h-opcode">add</span>    <span class="h-variable">rbx</span><span class="h-delim">,</span> <span class="h-number h-integer">1</span>
    <span class="h-opcode">cmp</span>    <span class="h-variable">rbp</span><span class="h-delim">,</span> <span class="h-variable">rbx</span>
    <span class="h-opcode h-recur">jne</span>    <span class="h-label">.L3</span>
</pre>
            </div>
          </div>
        </section>
        <section>
          <h2>Why isn’t it doing that?</h2>
          <ul>
            <li>Abstractly simple
              <ul>
                <li>Call <code>PyErr_CheckSignals</code> periodically</li>
                <li>If it returns −1, treat as failure; abandon work, return</li>
              </ul></li>
          </ul>
        </section>
        <section>
          <blockquote class="long-quote">
            <h2><code class="language-c"><span class="h-type h-keyword">int</span> <span class="h-defun">PyErr_CheckSignals</span><span class="h-delim">()</span></code></h2>
            <p><em>Part of the Stable ABI.</em></p>
            <p>This function interacts with Python’s signal handling.</p>
            <p>If the function is called from the main thread and under the main Python interpreter, it checks whether a
              signal has been sent to the processes and if so, invokes the corresponding signal handler. If the signal
              module is supported, this can invoke a signal handler written in Python.</p>
            <p>The function attempts to handle all pending signals, and then returns 0. However, if a Python signal
              handler raises an exception, the error indicator is set and the function returns −1 immediately (such
              that other pending signals may not have been handled yet: they will be on the next
              <code>PyErr_CheckSignals()</code> invocation).</p>
            <p>If the function is called from a non-main thread, or under a non-main Python interpreter, it does nothing
              and returns 0.</p>
            <p class="fragment highlight-green">
              This function can be called by long-running C code that wants to be interruptible by user requests (such
              as by pressing Ctrl-C).</p>
            <p>Note: The default Python signal handler for <code>SIGINT</code> raises the <code>KeyboardInterrupt</code>
              exception.</p>
          </blockquote>
        </section>
        <section>
          <h2>Why isn’t it doing that?</h2>
          <ul>
            <li class="pastbullet">Abstractly simple
              <ul>
                <li>Call <code>PyErr_CheckSignals</code> periodically</li>
                <li>If it returns −1, treat as failure; abandon work, return</li>
              </ul></li>
            <li>Not obvious from docs that you <em>need</em> to do that</li>
          </ul>
        </section>
        <section>
          <h2>Why isn’t it doing that?</h2>
          <div class="sidebyside">
            <div class="sidebyside-1">
              <pre class="language-c"
><span class="h-keyword h-type"><del>void</del></span>
<span class="h-defun">random_standard_uniform_fill</span><span class="h-delim">(</span>
    <span class="h-type">bitgen_t *</span><span class="h-variable">rng</span><span class="h-delim">,</span>
    <span class="h-type">npy_intp</span> <span class="h-variable">cnt</span><span class="h-delim">,</span> <span class="h-keyword h-type">double</span> <span class="h-type">*</span><span class="h-variable">out</span><span class="h-delim">)</span>
<span class="h-delim">{</span>
  <span class="h-type">npy_intp</span> <span class="h-variable">i</span><span class="h-delim">;</span>
  <span class="h-keyword">for</span> <span class="h-delim">(</span><span class="h-name">i</span> <span class="h-operator">=</span> <span class="h-number h-integer">0</span><span class="h-delim">;</span> <span class="h-name">i</span> <span class="h-operator">&lt;</span> <span class="h-name">cnt</span><span class="h-delim">;</span> <span class="h-name">i</span><span class="h-operator">++</span><span class="h-delim">)</span> <span class="h-delim">{</span>
    <span class="h-name">out</span><span class="h-delim">[</span><span class="h-name">i</span><span class="h-delim">]</span> <span class="h-operator">=</span> <span class="h-name">next_double</span><span class="h-delim">(</span><span class="h-name">rng</span><span class="h-delim">);</span>


  <span class="h-delim">}</span>

<span class="h-delim">}</span></pre>
            </div>
            <div class="sidebyside-2">
              <pre data-line-numbers="1,7,8,10" class="language-c"
><span class="h-keyword h-type"><ins>int</ins></span>
<span class="h-defun">random_standard_uniform_fill</span><span class="h-delim">(</span>
    <span class="h-type">bitgen_t *</span><span class="h-variable">rng</span><span class="h-delim">,</span>
    <span class="h-type">npy_intp</span> <span class="h-variable">cnt</span><span class="h-delim">,</span> <span class="h-keyword h-type">double</span> <span class="h-type">*</span><span class="h-variable">out</span><span class="h-delim">)</span>
<span class="h-delim">{</span>
  <span class="h-type">npy_intp</span> <span class="h-variable">i</span><span class="h-delim">;</span>
  <span class="h-keyword">for</span> <span class="h-delim">(</span><span class="h-name">i</span> <span class="h-operator">=</span> <span class="h-number h-integer">0</span><span class="h-delim">;</span> <span class="h-name">i</span> <span class="h-operator">&lt;</span> <span class="h-name">cnt</span><span class="h-delim">;</span> <span class="h-name">i</span><span class="h-operator">++</span><span class="h-delim">)</span> <span class="h-delim">{</span>
    <span class="h-name">out</span><span class="h-delim">[</span><span class="h-name">i</span><span class="h-delim">]</span> <span class="h-operator">=</span> <span class="h-name">next_double</span><span class="h-delim">(</span><span class="h-name">rng</span><span class="h-delim">);</span>
    <ins><span class="h-keyword">if</span> <span class="h-delim">(</span><span class="h-name">PyErr_CheckSignals</span><span class="h-delim">())</span></ins>
    <ins>  <span class="h-keyword">return</span> <span class="h-number h-integer">-1</span><span class="h-delim">;</span></ins>
  <span class="h-delim">}</span>
  <ins><span class="h-keyword">return</span> <span class="h-number h-integer">0</span><span class="h-delim">;</span></ins>
<span class="h-delim">}</span></pre>
            </div>
          </div>
        </section>
        <section>
          <h2>Why isn’t it doing that?</h2>
          <ul>
            <li class="pastbullet">Abstractly simple
              <ul>
                <li>Call <code>PyErr_CheckSignals</code> periodically</li>
                <li>If it returns −1, treat as failure; abandon work, return</li>
              </ul></li>
            <li class="pastbullet">Not obvious from docs that you <em>need</em> to do that</li>
            <li>Have to decide <em>where</em> and <em>how often</em> to do that</li>
            <li>Must propagate the −1 return all the way up your call chain</li>
          </ul>
        </section>
        <section>
          <blockquote class="long-quote">
            <h2><code class="language-c"><span class="h-type h-keyword">int</span> <span class="h-defun">PyErr_CheckSignals</span><span class="h-delim">()</span></code></h2>
            <p><em>Part of the Stable ABI.</em></p>
            <p>This function interacts with Python’s signal handling.</p>
            <p>If the function is called from the main thread and under the main Python interpreter, it checks whether a
              signal has been sent to the processes and if so, invokes the corresponding signal handler. <span class=
              "fragment highlight-red">If the signal module is supported, this can invoke a signal handler written in
              Python.</span></p>
            <p>The function attempts to handle all pending signals, and then returns 0. However, if a Python signal
              handler raises an exception, the error indicator is set and the function returns −1 immediately (such
              that other pending signals may not have been handled yet: they will be on the next
              <code>PyErr_CheckSignals()</code> invocation).</p>
            <p>If the function is called from a non-main thread, or under a non-main Python interpreter, it does nothing
              and returns 0.</p>
            <p style="color:#17ff2e">
              This function can be called by long-running C code that wants to be interruptible by user requests (such
              as by pressing Ctrl-C).</p>
            <p>Note: The default Python signal handler for <code>SIGINT</code> raises the <code>KeyboardInterrupt</code>
              exception.</p>
          </blockquote>
        </section>
        <section>
          <h2>Why isn’t it doing that?</h2>
          <div class="sidebyside">
            <div class="sidebyside-1">
              <pre class="language-c"
><span class="h-keyword h-type">int</span>
<span class="h-defun">random_standard_uniform_fill</span><span class="h-delim">(</span>
    <span class="h-type">bitgen_t *</span><span class="h-variable">rng</span><span class="h-delim">,</span>
    <span class="h-type">npy_intp</span> <span class="h-variable">cnt</span><span class="h-delim">,</span> <span class="h-keyword h-type">double</span> <span class="h-type">*</span><span class="h-variable">out</span><span class="h-delim">)</span>
<span class="h-delim">{</span>


  <span class="h-type">npy_intp</span> <span class="h-variable">i</span><span class="h-delim">;</span>
  <span class="h-keyword">for</span> <span class="h-delim">(</span><span class="h-name">i</span> <span class="h-operator">=</span> <span class="h-number h-integer">0</span><span class="h-delim">;</span> <span class="h-name">i</span> <span class="h-operator">&lt;</span> <span class="h-name">cnt</span><span class="h-delim">;</span> <span class="h-name">i</span><span class="h-operator">++</span><span class="h-delim">)</span> <span class="h-delim">{</span>
    <span class="h-name">out</span><span class="h-delim">[</span><span class="h-name">i</span><span class="h-delim">]</span> <span class="h-operator">=</span> <span class="h-name">next_double</span><span class="h-delim">(</span><span class="h-name">rng</span><span class="h-delim">);</span>
    <del><span class="h-keyword">if</span> <span class="h-delim">(</span><span class="h-name">PyErr_CheckSignals</span><span class="h-delim">())</span></del>
    <del>  <span class="h-keyword">return</span> <span class="h-number h-integer">-1</span><span class="h-delim">;</span></del>


  <span class="h-delim">}</span>
  <span class="h-keyword">return</span> <span class="h-number h-integer">0</span><span class="h-delim">;</span>
<span class="h-delim">}</span></pre>
            </div>
            <div class="sidebyside-2">
              <pre class="language-c"
><span class="h-keyword h-type">int</span>
<span class="h-defun">random_standard_uniform_fill</span><span class="h-delim">(</span>
    <span class="h-type">bitgen_t *</span><span class="h-variable">rng</span><span class="h-delim">,</span>
    <span class="h-type">npy_intp</span> <span class="h-variable">cnt</span><span class="h-delim">,</span> <span class="h-keyword h-type">double</span> <span class="h-type">*</span><span class="h-variable">out</span><span class="h-delim">)</span>
<span class="h-delim">{</span>
  <ins><span class="h-type">PyGILState_STATE</span> <span class="h-variable">st</span><span class="h-delim">;</span></ins>
  <ins><span class="h-keyword h-type">int</span> <span class="h-variable">err</span><span class="h-delim">;</span></ins>
  <span class="h-type">npy_intp</span> <span class="h-variable">i</span><span class="h-delim">;</span>
  <span class="h-keyword">for</span> <span class="h-delim">(</span><span class="h-name">i</span> <span class="h-operator">=</span> <span class="h-number h-integer">0</span><span class="h-delim">;</span> <span class="h-name">i</span> <span class="h-operator">&lt;</span> <span class="h-name">cnt</span><span class="h-delim">;</span> <span class="h-name">i</span><span class="h-operator">++</span><span class="h-delim">)</span> <span class="h-delim">{</span>
    <span class="h-name">out</span><span class="h-delim">[</span><span class="h-name">i</span><span class="h-delim">]</span> <span class="h-operator">=</span> <span class="h-name">next_double</span><span class="h-delim">(</span><span class="h-name">rng</span><span class="h-delim">);</span>
    <ins><span class="h-name">st</span> <span class="h-operator">=</span> <span class="h-name">PyGILState_Ensure</span><span class="h-delim">();</span></ins>
    <ins><span class="h-name">err</span> <span class="h-operator">=</span> <span class="h-name">PyErr_CheckSignals</span><span class="h-delim">();</span></ins>
    <ins><span class="h-name">PyGILState_Release</span><span class="h-delim">(</span><span class="h-name">st</span><span class="h-delim">);</span></ins>
    <ins><span class="h-keyword">if</span> <span class="h-delim">(</span><span class="h-name">err</span><span class="h-delim">)</span> <span class="h-keyword">return</span> <span class="h-name">err</span><span class="h-delim">;</span></ins>
  <span class="h-delim">}</span>
  <span class="h-keyword">return</span> <span class="h-number h-integer">0</span><span class="h-delim">;</span>
<span class="h-delim">}</span>


</pre>
            </div>
          </div>
        </section>
        <section>
          <h2>Why isn’t it doing that?</h2>
          <ul>
            <li class="pastbullet">Abstractly simple
              <ul>
                <li>Call <code>PyErr_CheckSignals</code> periodically</li>
                <li>If it returns −1, treat as failure; abandon work, return</li>
              </ul></li>
            <li class="pastbullet">Not obvious from docs that you <em>need</em> to do that</li>
            <li class="pastbullet">Have to decide <em>where</em> and <em>how often</em> to do that</li>
            <li class="pastbullet">Must propagate the −1 return all the way up your call chain</li>
            <li>
              <code>PyErr_CheckSignals</code> can run arbitrary Python code
              <ul>
                <li>Needs to be <em>safe</em> to run arbitrary Python</li>
                <li>May need to reclaim the GIL (expensive)</li>
              </ul></li>
          </ul>
        </section>
        <section>
          <h2>A more complicated example</h2>
          <div class="r-stack">
            <img class="figure" src="kfft-example-1.svg">
            <img class="figure-nobg fragment" src="kfft-example-2.svg">
          </div>
        </section>
        <section>
          <h2>Cost of checking for signals</h2>
          <div class="r-stack">
            <img class="figure" src="cost-check-sp-1.svg">
            <img class="figure-nobg fragment" src="cost-check-sp-2.svg">
            <img class="figure-nobg fragment" src="cost-check-sp-3.svg">
            <img class="figure-nobg fragment" src="cost-check-sp-4.svg">
          </div>
        </section>
        <section>
          <div class="r-stack">
            <h2>Cost of checking for signals</h2>
          </div>
          <div class="r-stack">
            <img class="figure" src="cost-per-sample-1.svg">
          </div>
        </section>
        <section>
          <h2>What if we didn’t check every time?</h2>
          <div class="r-stack">
            <img class="figure" src="kfft-example-1.svg">
            <img class="figure-nobg fragment fade-out" data-fragment-index="1" src="kfft-example-2.svg">
            <img class="figure-nobg fragment fade-in" data-fragment-index="1" src="kfft-example-3.svg">
          </div>
        </section>
        <section>
          <div class="r-stack">
            <h2 class="fragment fade-out" data-fragment-index="1">What if we didn’t check every time?</h2>
            <h2 class="fragment fade-in" data-fragment-index="1">Claw back more speed with coarse clock</h2>
          </div>
          <div class="r-stack">
            <img class="figure" src="cost-per-sample-1.svg">
            <img class="figure-nobg" src="cost-per-sample-2.svg">
            <img class="figure-nobg fragment" data-fragment-index="1" src="cost-per-sample-3.svg">
          </div>
        </section>
        <section>
          <h2>Longer intervals don’t help</h2>
          <div class="r-stack">
          <img class="figure" src="cost-by-interval-median.svg">
          </div>
        </section>
        <section>
          <h2>Recap</h2>
          <ul>
            <li>CPython interpreter cannot raise
              <code>KeyboardInterrupt</code> directly from its
              C-level signal handler
              <ul>
                <li>Must return to main interpreter loop before raising exceptions</li>
                <li>Prompt return needs cooperation from compiled-code extensions</li>
              </ul>
            </li>
            <li>Many extensions do not cooperate
              <ul>
                <li>Need to do this has not been well advertised</li>
                <li>Retrofit requires finicky code changes</li>
                <li>Substantial runtime costs</li>
              </ul>
            </li>
          </ul>
        </section>
        <section>
          <h2>Short term recommendation</h2>
          <pre class="language-c long-example"
><span class="h-directive">#ifndef</span> CLOCK_MONOTONIC_COARSE
<span class="h-directive">#define</span> <span class="h-variable">CLOCK_MONOTONIC_COARSE</span>  CLOCK_MONOTONIC
<span class="h-directive">#endif</span>
<span class="h-directive">#define</span> <span class="h-variable">ONE_MS_IN_NS</span> 1000000
<span class="h-directive">#define</span> <span class="h-variable">ONE_S_IN_NS</span>  1000000000

<span class="h-keyword h-type">int</span> <span class="h-defun">CheckSignalsOftenEnough</span><span class="h-delim">()</span>
<span class="h-delim">{</span>
  <span class="h-keyword">static</span> <span class="h-keyword h-type">struct</span> <span class="h-type">timespec</span> <span class="h-variable">last_check</span> <span class="h-operator">=</span> <span class="h-delim">{</span> <span class="h-number h-integer">0</span><span class="h-delim">,</span> <span class="h-number h-integer">0</span> <span class="h-delim">};</span>
  <span class="h-keyword h-type">struct</span> <span class="h-type">timespec</span> <span class="h-variable">now</span><span class="h-delim">;</span>
  <span class="h-name">clock_gettime</span><span class="h-delim">(</span><span class="h-name">CLOCK_MONOTONIC_COARSE</span><span class="h-delim">,</span> <span class="h-operator">&amp;</span><span class="h-name">now</span><span class="h-delim">);</span>

  <span class="h-keyword">if</span> <span class="h-delim">(</span>   <span class="h-name">now</span><span class="h-delim">.</span><span class="h-name">tv_sec</span>  <span class="h-operator">&lt;</span>  <span class="h-name">last_check</span><span class="h-delim">.</span><span class="h-name">tv_sec</span>      <span class="h-comment h-com-single">// monotonic clock went backward?!</span>
      <span class="h-operator">||</span> <span class="h-name">now</span><span class="h-delim">.</span><span class="h-name">tv_sec</span>  <span class="h-operator">&gt;</span>  <span class="h-name">last_check</span><span class="h-delim">.</span><span class="h-name">tv_sec</span> <span class="h-operator">+</span> <span class="h-number h-integer">1</span>  <span class="h-comment h-com-single">// more than 1s since last check</span>
      <span class="h-operator">||</span> <span class="h-delim">(</span><span class="h-name">now</span><span class="h-delim">.</span><span class="h-name">tv_sec</span> <span class="h-operator">==</span> <span class="h-name">last_check</span><span class="h-delim">.</span><span class="h-name">tv_sec</span>      <span class="h-comment h-com-single">// same second, more than 1ms</span>
          <span class="h-operator">&amp;&amp;</span> <span class="h-name">now</span><span class="h-delim">.</span><span class="h-name">tv_nsec</span> <span class="h-operator">&gt;</span> <span class="h-name">last_check</span><span class="h-delim">.</span><span class="h-name">tv_nsec</span> <span class="h-operator">+</span> <span class="h-name">ONE_MS_IN_NS</span><span class="h-delim">)</span>
      <span class="h-operator">||</span> <span class="h-name">now</span><span class="h-delim">.</span><span class="h-name">tv_nsec</span> <span class="h-operator">+</span> <span class="h-name">ONE_S_IN_NS</span>             <span class="h-comment h-com-single">// different second, ditto</span>
         <span class="h-operator">&gt;</span> <span class="h-name">last_check</span><span class="h-delim">.</span><span class="h-name">tv_nsec</span> <span class="h-operator">+</span> <span class="h-name">ONE_MS_IN_NS</span>
  <span class="h-delim">)</span> <span class="h-delim">{</span>
    <span class="h-name">last_check</span> <span class="h-operator">=</span> <span class="h-name">now</span><span class="h-delim">;</span>
    <span class="h-type">PyGILState_STATE</span> <span class="h-variable">st</span> <span class="h-operator">=</span> <span class="h-name">PyGilState_Ensure</span><span class="h-delim">();</span>
    <span class="h-keyword h-type">int</span> <span class="h-variable">err</span> <span class="h-operator">=</span> <span class="h-name">PyErr_CheckSignals</span><span class="h-delim">();</span>
    <span class="h-name">PyGILState_Release</span><span class="h-delim">(</span><span class="h-name">st</span><span class="h-delim">);</span>
    <span class="h-keyword">return</span> <span class="h-name">err</span><span class="h-delim">;</span>
  <span class="h-delim">}</span>
  <span class="h-keyword">return</span> <span class="h-number h-integer">0</span><span class="h-delim">;</span>
<span class="h-delim">}</span></pre>
        </section>
        <section>
          <h2>How can we make this better?</h2>
          <ul><li>Improve core documentation
              <ul>
                <li>Highlight need to call <code>PyErr_CheckSignals</code> regularly</li>
                <li>Explain how to do so safely</li>
                <li>Explain how to do so efficiently</li>
              </ul>
          </li></ul>
        </section>
        <section>
          <h2>How can we make this better?</h2>
          <ul><li>Don’t require GIL to call <code>PyErr_CheckSignals</code>
              <ul>
                <li>Cost of frequent checks is mostly cost of locking</li>
                <li>Signal flag is already an atomic variable! Don’t need GIL to test it</li>
                <li>Have <code>PyErr_CheckSignals</code> claim GIL itself, <em>only if flag is set</em></li>
                <li>(Still needs to be <em>safe</em> to take GIL at any callsite)</li>
                <li>Proposed for Python 3.14: [TODO: pull request URL]</li>
              </ul>
          </li></ul>
        </section>
        <section>
          <h2>How can we make this better?</h2>
          <ul><li>Make Cython, Numba, and similar tools insert checks for you</li></ul>
          <div class="sidebyside">
            <div class="sidebyside-1">
              <pre class="language-cython"
><span class="h-keyword">cdef</span> <span class="h-defun">random_standard_uniform_fill</span><span class="h-delim">(</span>
    <span class="h-type">bitgen_t</span> <span class="h-variable">rng</span><span class="h-delim">,</span>
    <span class="h-type">double</span> <span class="h-delim">[:]</span> <span class="h-variable">out</span><span class="h-delim">,</span>
<span class="h-delim">)</span> <span class="h-keyword">nogil</span><span class="h-delim">:</span>
    <span class="h-keyword">for</span> <span class="h-variable">i</span> <span class="h-operator-word">in</span> <span class="h-name h-builtin">range</span><span class="h-delim">(</span><span class="h-name h-builtin">len</span><span class="h-delim">(</span><span class="h-name">out</span><span class="h-delim">)):</span>
        <span class="h-name">out</span><span class="h-delim">[</span><span class="h-name">i</span><span class="h-delim">]</span> <span class="h-operator">=</span> <span class="h-name">next_double</span><span class="h-delim">(</span><span class="h-name">rng</span><span class="h-delim">)</span></pre>
            </div>
            <div class="sidebyside-2">
              <pre class="language-c"
><span class="h-keyword h-type">int</span> <span class="h-defun">random_standard_uniform_fill</span><span class="h-delim">(</span>
    <span class="h-type">bitgen_t</span> <span class="h-variable">rng</span><span class="h-delim">,</span>
    <span class="h-type">__Pyx_memviewslice</span> <span class="h-variable">out</span>
<span class="h-delim">)</span> <span class="h-delim">{</span>
  <span class="h-type">Py_ssize_t</span> <span class="h-variable">i</span><span class="h-delim">;</span>
  <span class="h-type">Py_ssize_t</span> <span class="h-variable">len</span><span class="h-delim">;</span>
  <span class="h-name">len</span> <span class="h-operator">=</span> <span class="h-name">__Pyx_MemoryView_Len</span><span class="h-delim">(</span><span class="h-name">out</span><span class="h-delim">);</span>
  <span class="h-keyword">for</span> <span class="h-delim">(</span><span class="h-name">i</span> <span class="h-operator">=</span> <span class="h-number h-integer">0</span><span class="h-delim">;</span> <span class="h-name">i</span> <span class="h-operator">&lt;</span> <span class="h-name">len</span><span class="h-delim">;</span> <span class="h-name">i</span> <span class="h-operator">+=</span> <span class="h-number h-integer">1</span><span class="h-delim">)</span> <span class="h-delim">{</span>
    <span class="h-operator">*</span><span class="h-delim">((</span><span class="h-keyword h-type">double</span> <span class="h-operator">*</span><span class="h-delim">)</span>
      <span class="h-delim">((</span><span class="h-name">out</span><span class="h-delim">.</span><span class="h-name">data</span> <span class="h-operator">+</span>
        <span class="h-name">i</span> <span class="h-operator">*</span> <span class="h-name">out</span><span class="h-delim">.</span><span class="h-name">strides</span><span class="h-delim">[</span><span class="h-number h-integer">0</span><span class="h-delim">])))</span> <span class="h-operator">=</span>
      <span class="h-name">next_double</span><span class="h-delim">(</span><span class="h-name">rng</span><span class="h-delim">);</span>
    <span class="fragment custom insert" data-fragment-index="1"><span class="h-keyword">if</span> <span class="h-delim">(</span><span class="h-name">CheckSignalsOftenEnough</span><span class="h-delim">())</span></span>
    <span class="fragment custom insert" data-fragment-index="1">  <span class="h-keyword">return</span> <span class="h-number h-integer">-1</span><span class="h-delim">;</span></span>
  <span class="h-delim">}</span>
  <span class="h-keyword">return</span> <span class="h-number h-integer">0</span><span class="h-delim">;</span>
<span class="h-delim">}</span>

</pre>
            </div>
          </div>
        </section>
        <section>
          <h2>How can we make this better?</h2>
          <ul><li>In tools like PyO3, model control-C as async cancellation</li></ul>
          <pre class="language-rust"
><span class="h-directive">#[pyfunction]</span>
<span class="h-keyword">async</span> <span class="h-keyword">fn</span> <span class="h-defun">random_standard_uniform_fill</span><span class="h-delim">(</span>
    <span class="h-directive">#[pyo3(cancel_handle)]</span> <span class="h-keyword">mut</span> <span class="h-variable">cancel</span><span class="h-delim">:</span> <span class="h-type">CancelHandle</span><span class="h-delim">,</span>
    <span class="h-variable">rng</span><span class="h-delim">:</span> <span class="h-type">BitGen</span><span class="h-delim">,</span>
    <span class="h-variable">out</span><span class="h-delim">:</span> <span class="h-keyword h-type">&amp;mut</span> <span class="h-type">f64[]</span><span class="h-delim">,</span>
<span class="h-delim">)</span> <span class="h-delim">{</span>
    <span class="h-name">futures</span><span class="h-delim">::</span><span class="h-name">select</span><span class="h-operator">!</span> <span class="h-delim">{</span>
        <span class="h-name">cancel</span><span class="h-delim">.</span><span class="h-name">cancelled</span><span class="h-delim">.</span><span class="h-name">fuse</span><span class="h-delim">()</span> <span class="h-operator">=&gt;</span> <span class="h-delim">{},</span>
        <span class="h-name">_</span> <span class="h-operator">=&gt;</span> <span class="h-delim">{</span>
            <span class="h-keyword">for</span> <span class="h-variable">i</span> <span class="h-keyword">in</span> <span class="h-number h-integer">0</span><span class="h-operator">..</span><span class="h-name">out</span><span class="h-delim">.</span><span class="h-name">len</span><span class="h-delim">()</span> <span class="h-delim">{</span>
                <span class="h-name">out</span><span class="h-delim">[</span><span class="h-name">i</span><span class="h-delim">]</span> <span class="h-operator">=</span> <span class="h-name">rng</span><span class="h-delim">.</span><span class="h-name">next_double</span><span class="h-delim">();</span>
            <span class="h-delim">}</span>
        <span class="h-delim">}</span>
    <span class="h-delim">}</span>
<span class="h-delim">}</span>


</pre>
        </section>
        <section>
          <h2>How can we make this better?</h2>
          <ul><li>Turn Python into a shell-structured language</li></ul>
          <div class="sidebyside">
            <div class="sidebyside-1">
              <pre class="fragment language-python-repl" data-fragment-index="1"
><span class="h-prompt">&gt;&gt;&gt; </span><span class="h-keyword h-namespace">import</span> <span class="h-name h-namespace">numpy</span> <span class="h-keyword">as</span> <span class="h-name h-namespace">np</span>
<span class="h-prompt">&gt;&gt;&gt; </span><span class="h-variable">rng</span> <span class="h-operator">=</span> <span class="h-name">np</span><span class="h-operator">.</span><span class="h-name">random</span><span class="h-operator">.</span><span class="h-name">default_rng</span><span class="h-delim">()</span>
<span class="h-prompt">&gt;&gt;&gt; </span><span class="h-keyword">def</span> <span class="h-defun">g</span><span class="h-delim">(</span><span class="h-variable">n</span><span class="h-operator">=</span><span class="h-number h-integer">1000000000</span><span class="h-delim">):</span>
<span class="h-prompt">... </span>    <span class="h-keyword">return</span> <span class="h-name">rng</span><span class="h-operator">.</span><span class="h-name">random</span><span class="h-delim">(</span><span class="h-name">n</span><span class="h-delim">)</span>
<span class="h-prompt">...</span>
<span class="h-prompt">&gt;&gt;&gt; </span><span class="h-name">g</span><span class="h-delim">()</span></pre>
            </div>
            <div class="sidebyside-2">
              <ul>
                <li class="fragment" data-fragment-index="1">Evaluate <code>g()</code> in a <em>subprocess</em></li>
                <li class="fragment" data-fragment-index="1">Pass the result back via shared memory or something</li>
                <li class="fragment">(This is why the Unix shell doesn’t have the same problem)</li>
              </ul>
            </div>
          </div>
        </section>
        <section>
          <h2>How can we make this better?</h2>
          <ul><li>Brainstorming time!
              <ul>
                <li>Call out your ideas</li>
                <li>Or ask a question</li>
                <li>One sentence per person</li>
              </ul>
          </li></ul>
        </section>
        <section>
          <h2>Colophon</h2>
          <ul>
            <li><p>All the code shown in this presentation, the raw data,
              and the analysis scripts may be found<br>
              at <a href="https://github.com/MillionConcepts/cpython-ext-ctrl-c"><code>https://github.com/MillionConcepts/cpython-ext-ctrl-c</code></a><br>
              or <a href="https://git.sr.ht/~zackw/cpython-ext-ctrl-c"><code>https://git.sr.ht/~zackw/cpython-ext-ctrl-c</code></a><br>
              and may be reused under Million Concepts’ usual 3-clause BSD license</p></li>
            <li>Fonts used in this presentation: <a href="https://github.com/alerque/libertinus">Libertinus Sans</a> and <a href="https://github.com/polarsys/b612">B612 Mono</a></li>
            <li>Data visualization thanks to <a href="https://ggplot2.tidyverse.org/">ggplot2</a> and <a href="https://wilkelab.org/cowplot/">cowplot</a></li>
            <li>Graphics postprocessed to various degrees in <a href="https://inkscape.org/">Inkscape</a></li>
            <li>Slide deck rendered with <a href="https://revealjs.com/">reveal.js</a>
          </ul>
        </section>
      </div>
      <script src="rjs/reveal.js"></script>
      <script src="rjs/plugin-notes.js"></script>
      <script>
        // More info about initialization & config:
        // - https://revealjs.com/initialization/
        // - https://revealjs.com/config/
        Reveal.initialize({
          hash: true,
          // Learn about plugins: https://revealjs.com/plugins/
          plugins: [ RevealNotes ],
          transition: "fade",
          center: false,
          width: 1920,
          height: 1080,
        });
      </script>
    </div>
  </body>
</html>
<!--
  -- Local Variables:
  -- sgml-basic-offset: 2;
  -- End:
  -->
